Имеет 2 операции:
1. write(...)
2. read(...)

Клиенты могут одновременно читать с одной машины и писать в другую.

![[репликация.png]]

Реализация:
История (начало вызова -> завершение вызова -> результат)

Спецификация: набор допустимых последовательных историй.
Реализация порождает набор конкурентных условий.

![[реализация и спецификация.png]]

Наша реализация sequantially consistent если она порождает истории такие что, каждая история имеет линейное объяснение в котором чтения в с спецификации и реализации одинаковы и при этом сохраняется результат операции внутри каждого клиента.

Sequantiall consistency частный случай модели согласованности. Модель согласованности описанная выше называется линеаризуемость.
Другими словами любая история линеаризуема. 

Write(1), Read(1), Write(2)

Формальное определение линеаризуемости:
h - история
spec - специализация
impl - реализация

![[формальное определение линеаризуемости.png]]

Для упорядоченности по времени нужна гарантия happens before.

Линеаризацию еще называют External Consistency, предполагая, что есть коммуникация снаружи системы и она будет учтена.

---

Мы хотим построить линеаризуемую ячейку памяти (атомарный регистр)
Операции:
1. write(...)
2. read(...)
Асинхронная модель, ячейка памяти может закрашиться или зарестартиться.
 
Чтобы все упорядочить клиент отправляет не только запись, но и время когда он отправил.

Нужно обратить внимание на буквы: t - timestamp. (работает корректно только если запись завершилась до чтения)

![[чтение и запись атомарного регистра.png]]

Система кворумов:
P - множество всех узлов
q - подмножество P (система кворумов)

![[система кворумов.png]]

Простыми словами, нам надо с минимального количества реплик прочитать значения и нужно чтобы хотя бы одно из них было верным.

Для системы из 9 реплик хватит опросить 5 из них чтобы вернуло верное значение, если у нас на 5 репликах из 9 есть верное значение. Таким образом ты переживаешь 4 отказа.

Система кворумов позволяет скрывать отказы от пользователей.

Нарушение линеаризуемости:
![[нарушение линеаризуемости.png]]

Как исправить - если получили разные значения при чтении, то записываем на кворум реплик (нод) последнее из двух значений.

Чтобы гарантировать еще и правильное время при ситуации где много writer'ов нам нужно перед каждой записью делать чтение timestamp'ов

![[второй костыль линеаризуемости.png]]

#линеаризуемость

![[сериализация.png]]